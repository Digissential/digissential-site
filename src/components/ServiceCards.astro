---
import { getCollection } from "astro:content";
import { resolveSlug, mediaForService } from "@lib/serviceMedia";

export interface Props { title?: string; slugs?: string[]; }

const CORE = [
  "laptop-screen-replacement",
  "battery-replacement",
  "virus-malware-removal",
  "data-recovery",
  "wifi-network-troubleshooting",
  "remote-it-support",
];

const { title, slugs } = Astro.props;
const wanted = (slugs?.length ? slugs : CORE).map(resolveSlug);

const all = await getCollection("services", ({ slug, data }) =>
  wanted.includes(resolveSlug(slug)) && data.visibility !== "internal" && !data.noindex
);

// Keep UI order, attach media
const services = wanted.map((key) => {
  const entry = all.find((e) => resolveSlug(e.slug) === key);
  if (!entry) return null;
  const m = mediaForService(key, entry.slug, entry.data.title);
  return {
    slug: entry.slug,
    title: entry.data.title,
    summary: entry.data.summary,
    thumb: m?.src,
    alt: m?.alt || entry.data.title,
  };
}).filter(Boolean);

const site = (Astro.site?.toString?.() || "https://digissential.co.za").replace(/\/+$/, "");
const itemListLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  name: title ?? "Popular services in Stellenbosch",
  itemListElement: services.map((s, i) => ({
    "@type": "ListItem",
    position: i + 1,
    name: s.title,
    url: `${site}/services/${s.slug}/`,
    image: s.thumb ? new URL(s.thumb, site).toString() : undefined,
  })),
};
---

<section class="mt-8">
  <h2 class="text-xl font-bold">{title ?? "Popular services in Stellenbosch"}</h2>

  <ul class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2">
    {services.map((s) => (
      <li class="card p-0 overflow-hidden">
        <a href={`/services/${s.slug}/`} class="block rounded-[inherit] focus:outline-none focus:ring-2 focus:ring-digi-primary">
          {s.thumb && (
            <figure>
              <img
                src={s.thumb}
                alt={s.alt}
                width="800"
                height="450"
                loading="lazy"
                decoding="async"
                sizes="(min-width: 768px) 50vw, 100vw"
                class="w-full aspect-[16/9] object-cover"
              />
            </figure>
          )}
          <div class="p-3">
            <h3 class="font-semibold">{s.title}</h3>
            {s.summary && <p class="text-sm text-white/70 mt-0.5">{s.summary}</p>}
          </div>
        </a>
      </li>
    ))}
  </ul>

  <script type="application/ld+json" set:html={JSON.stringify(itemListLd)} />
</section>
