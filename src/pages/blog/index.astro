---
// src/pages/blog/index.astro
import Base from '@layouts/Base.astro';
import Breadcrumbs from '@components/Breadcrumbs.astro';
import { getCollection } from 'astro:content';
import fs from 'node:fs';

// Posts (no drafts), newest first
const posts = (await getCollection('blog'))
  .filter(p => !p.data.draft)
  .sort((a,b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

// Tag counts → top + more
const tagCounts = new Map<string, number>();
for (const p of posts) for (const t of (p.data.tags ?? [])) {
  tagCounts.set(t, (tagCounts.get(t) || 0) + 1);
}
const allTags = [...tagCounts.entries()]
  .sort((a,b) => (b[1] - a[1]) || a[0].localeCompare(b[0]))
  .map(([slug, count]) => ({ slug, label: slug.replace(/-/g,' '), count }));
const MAX_INLINE_TAGS = 8;
const topTags  = allTags.slice(0, MAX_INLINE_TAGS);
const moreTags = allTags.slice(MAX_INLINE_TAGS);

const base = (Astro.site?.toString?.() || 'https://digissential.co.za').replace(/\/+$/, '');
const itemListLd = {
  '@context': 'https://schema.org',
  '@type': 'ItemList',
  itemListElement: posts.map((e, i) => ({
    '@type': 'ListItem',
    position: i + 1,
    url: `${base}/blog/${e.slug}/`,
    name: e.data.title
  }))
};

const fmtDate = (d: Date) =>
  new Intl.DateTimeFormat('en-ZA', { year: 'numeric', month: 'short', day: '2-digit' }).format(d);

const subscribeHref = '/rss.xml';

// Helper: does a /public image actually exist?
const hasPublicFile = (p?: string) => {
  if (!p || !p.startsWith('/')) return false;
  try {
    return fs.existsSync(new URL('../../../public' + p, import.meta.url));
  } catch { return false; }
};
---

<Base
  title="Blog — Digissential"
  description="Short, practical posts to keep your devices healthy — repair tips, malware hygiene, backup basics, and more."
  ogImage="/images/brand-cover-1200x630.jpg"
>


  <script type="application/ld+json" set:html={JSON.stringify(itemListLd)} />

  <main class="container-prose pt-4">
    <Breadcrumbs items={[ { href: '/blog/', label: 'Blog' } ]} />

    <!-- Hero -->
    <section class="mt-4 card p-5 md:p-6 hero-bg">
      <h1 class="text-2xl md:text-3xl font-extrabold">Blog</h1>
      <p class="mt-1 text-white/75 max-w-2xl">
        Short, practical posts to keep your devices healthy — with repair tips, malware hygiene, backup basics, and more.
      </p>

      <div class="mt-4 flex flex-wrap gap-3 items-center">
        <form id="search" class="flex-1 min-w-[240px] flex gap-2">
          <input id="q" type="search" enterkeyhint="search"
            placeholder="Search posts (e.g., malware, backup, windows)…"
            class="w-full rounded-2xl bg-white/10 px-4 py-2 outline-none focus:ring-2 focus:ring-digi-primary"
            autocomplete="off" />
          <button class="btn btn-primary" type="submit">Search</button>
        </form>
        <a href={subscribeHref} class="btn btn-outline">Subscribe</a>
        <p class="mt-2 text-sm text-white/70">
          Prefer deep, citation-first guides? <a href="/resources/" class="link-fancy">Browse Resources →</a>
        </p>
      </div>

      {allTags.length > 0 && (
        <div class="mt-3 space-y-2">
          <!-- Inline (top) tags -->
          <ul id="tags-inline" class="flex flex-wrap gap-2 text-xs">
            <li><button type="button" data-tag="" aria-pressed="true"
              class="px-2 py-1 rounded bg-white/10 hover:bg-white/15">All</button></li>
            {topTags.map(t => (
              <li><button type="button" data-tag={t.slug} aria-pressed="false"
                class="px-2 py-1 rounded bg-white/10 hover:bg-white/15">
                {t.label} ({t.count})
              </button></li>
            ))}
            {moreTags.length > 0 && (
              <li>
                <button id="more-tags" type="button" aria-expanded="false" aria-controls="tags-more"
                  class="px-2 py-1 rounded bg-white/10 hover:bg-white/15">More tags</button>
              </li>
            )}
          </ul>

          <!-- Hidden panel with the rest -->
          {moreTags.length > 0 && (
            <div id="tags-more" class="hidden">
              <ul class="flex flex-wrap gap-2 text-xs">
                {moreTags.map(t => (
                  <li><button type="button" data-tag={t.slug} aria-pressed="false"
                    class="px-2 py-1 rounded bg-white/10 hover:bg-white/15">
                    {t.label} ({t.count})
                  </button></li>
                ))}
              </ul>
            </div>
          )}
        </div>
      )}
    </section>

    <!-- Posts -->
    <p id="result-count" class="mt-6 text-sm text-white/60" aria-live="polite" aria-atomic="true">
      {posts.length} posts
    </p>
    <section class="mt-2 grid gap-3 md:grid-cols-2">
      {posts.map(p => {
        const tags = p.data.tags || [];
        const shown = tags.slice(0, 3);
        const extra = Math.max(0, tags.length - shown.length);
        const hero = p.data.hero?.src;
        const showHero = hasPublicFile(hero);
        const heroAlt = p.data.hero?.alt ?? '';
        const updated = p.data.updatedDate && p.data.updatedDate > p.data.pubDate;
        return (
          <article
            class="post relative group card p-3 md:p-4 hover:shadow-md transition
                   focus-within:ring-2 focus-within:ring-digi-primary/70"
            data-title={(p.data.title || '').toLowerCase()}
            data-desc={(p.data.description || '').toLowerCase()}
            data-tags={tags.join(',').toLowerCase()}
          >
            <a href={`/blog/${p.slug}/`} class="absolute inset-0 rounded-[inherit]" aria-label={`Read: ${p.data.title}`}></a>
            <div class="flex gap-3 md:gap-4">
              {showHero && (
                <img
                  src={hero!}
                  alt={heroAlt}
                  loading="lazy"
                  decoding="async"
                  class="hidden sm:block h-16 w-24 md:h-20 md:w-28 rounded-lg object-cover flex-none"
                />
              )}
              <div class="min-w-0">
                <h2 class="text-base md:text-lg font-semibold leading-tight text-white clamp-2 group-hover:underline">
                  {p.data.title}
                </h2>
                <p class="mt-0.5 text-white/60 text-[11px] md:text-xs">
                  {fmtDate(p.data.pubDate)}
                  {updated && ` · Updated ${fmtDate(p.data.updatedDate as Date)}`}
                  {p.data.author ? ` · ${p.data.author}` : ''}
                </p>
                {p.data.description && (
                  <p class="mt-1 text-white/80 text-xs sm:text-sm clamp-2">{p.data.description}</p>
                )}
                {shown.length > 0 && (
                  <ul class="mt-1.5 flex flex-wrap gap-1 text-[10.5px]">
                    {shown.map(t => <li class="px-2 py-0.5 rounded bg-white/10">{t}</li>)}
                    {extra > 0 && <li class="px-2 py-0.5 rounded bg-white/5 text-white/60">+{extra}</li>}
                  </ul>
                )}
              </div>
            </div>
          </article>
        );
      })}
      {posts.length === 0 && <p class="text-white/60">No posts yet.</p>}

      <p id="no-results" class="hidden text-white/60">No posts match your search/tag.</p>
    </section>
    <p class="mt-8 text-center text-sm text-white/70">
      Looking for in-depth “how-to” pages? <a href="/resources/" class="link-fancy">See Resources →</a>
    </p>
  </main>

  <!-- Client-side search + tag filter -->
  <script>
  (() => {
    const $  = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    const searchForm = $('#search');
    const q = $('#q');
    const cards = $$('.post');
    const countEl = $('#result-count');
    const empty = $('#no-results');

    const moreBtn  = $('#more-tags');
    const moreWrap = $('#tags-more');

    const getTagButtons = () => $$('[data-tag]');
    let activeTag = '';

    const params  = new URLSearchParams(location.search);
    const initQ   = (params.get('q') || '').toLowerCase();
    const initTag = (params.get('tag') || '').toLowerCase();
    if (q) q.value = initQ;
    if (initTag) activeTag = initTag;

    const norm = (s) => (s || '').toLowerCase().trim();

    function setTagPressed(tag) {
      getTagButtons().forEach(btn => {
        const on = (btn.dataset.tag || '') === tag;
        btn.classList.toggle('ring-2', on);
        btn.classList.toggle('ring-digi-primary', on);
        btn.setAttribute('aria-pressed', String(on));
        if (tag === '' && btn.dataset.tag === '') {
          btn.classList.add('ring-2','ring-digi-primary');
          btn.setAttribute('aria-pressed','true');
        }
      });
    }

    function apply() {
      const qs = norm(q?.value);
      let shown = 0;

      cards.forEach(card => {
        const title = (card.dataset.title || '');
        const desc  = (card.dataset.desc  || '');
        const tags  = (card.dataset.tags  || '');
        const okText = !qs || title.includes(qs) || desc.includes(qs);
        const okTag  = !activeTag || tags.split(',').includes(activeTag);
        const ok = okText && okTag;
        card.style.display = ok ? '' : 'none';
        if (ok) shown++;
      });

      if (empty) empty.classList.toggle('hidden', shown !== 0);
      if (countEl) countEl.textContent = `${shown} ${shown === 1 ? 'post' : 'posts'}`;

      const next = new URL(location.href);
      if (qs) next.searchParams.set('q', qs); else next.searchParams.delete('q');
      if (activeTag) next.searchParams.set('tag', activeTag); else next.searchParams.delete('tag');
      history.replaceState(null, '', next);
    }

    searchForm?.addEventListener('submit', (e) => { e.preventDefault(); apply(); });
    q?.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); apply(); } });
    q?.addEventListener('search', () => apply());
    q?.addEventListener('input', () => { clearTimeout(q._t); q._t = setTimeout(apply, 120); });

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-tag]');
      if (!btn) return;
      activeTag = (btn.dataset.tag || '');
      setTagPressed(activeTag);
      apply();
    });

    moreBtn?.addEventListener('click', () => {
      const open = moreWrap?.classList.toggle('hidden') === false;
      moreBtn.setAttribute('aria-expanded', String(open));
      moreBtn.textContent = open ? 'Fewer tags' : 'More tags';
    });

    setTagPressed(activeTag || '');
    apply();
  })();
  </script>
</Base>
