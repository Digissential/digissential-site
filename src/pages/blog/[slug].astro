---
import Base from '@layouts/Base.astro';
import Breadcrumbs from '@components/Breadcrumbs.astro';
import { getCollection } from 'astro:content';

// 1) Pre-render ALL blog slugs (non-draft), oldest → newest for prev/next
export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);
  posts.sort((a, b) => new Date(a.data.pubDate).valueOf() - new Date(b.data.pubDate).valueOf());

  return posts.map((entry, i) => {
    const prev = i > 0 ? { slug: posts[i - 1].slug, title: posts[i - 1].data.title } : null;
    const next = i < posts.length - 1 ? { slug: posts[i + 1].slug, title: posts[i + 1].data.title } : null;
    return { params: { slug: entry.slug }, props: { entry, prev, next } };
  });
}

// 2) Receive props from getStaticPaths
const { entry, prev = null, next = null } = Astro.props as {
  entry: any;
  prev: { slug: string; title: string } | null;
  next: { slug: string; title: string } | null;
};

const { data } = entry;
const { Content } = await entry.render();

// Reading time (≈200 wpm) from raw body text
const words = String(entry.body ?? '').trim().split(/\s+/).filter(Boolean).length;
const minutes = Math.max(1, Math.round(words / 200));

// SEO helpers
const site = Astro.site?.toString?.() || 'https://www.digissential.co.za';
const url = new URL(`/blog/${entry.slug}/`, site).toString();
const desc = data.summary ?? data.description ?? '';
const ogImage = data.image ? new URL(data.image, site).toString() : new URL('/social.png', site).toString();

// JSON-LD
const articleLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: data.title,
  description: desc,
  datePublished: new Date(data.pubDate).toISOString(),
  ...(data.updatedDate ? { dateModified: new Date(data.updatedDate).toISOString() } : {}),
  author: { '@type': 'Organization', name: data.author || 'Digissential' },
  mainEntityOfPage: url,
  url,
  image: [ogImage],
};
---

<Base title={`${data.title} — Digissential`} description={desc} ogImage={ogImage}>
  <main class="container-prose pt-6">
    <!-- Home is auto-added by Breadcrumbs; just pass Blog + current -->
    <Breadcrumbs items={[
      { href: '/blog/', label: 'Blog' },
      { href: `/blog/${entry.slug}/`, label: data.title }
    ]} />

    <article class="mt-6">
      <!-- Branded header -->
      <header class="relative overflow-hidden rounded-3xl border border-white/5 bg-gradient-to-br from-white/[0.03] to-white/[0.01] p-6 sm:p-8">
        <svg aria-hidden="true" class="pointer-events-none absolute inset-0 h-full w-full opacity-[0.07]">
          <defs>
            <pattern id="grid" width="32" height="32" patternUnits="userSpaceOnUse">
              <path d="M32 0H0V32" fill="none" stroke="currentColor" stroke-width="0.75" />
            </pattern>
            <radialGradient id="glow" cx="50%" cy="0%" r="80%">
              <stop offset="0%" stop-color="rgb(56 189 248)" stop-opacity="0.25" />
              <stop offset="100%" stop-color="transparent" />
            </radialGradient>
          </defs>
          <rect width="100%" height="100%" fill="url(#grid)" />
          <rect width="120%" height="60%" x="-10%" y="-10%" fill="url(#glow)" />
        </svg>

        <div class="relative">
          <h1 class="text-3xl sm:text-4xl font-extrabold">{data.title}</h1>
          {desc && <p class="mt-2 text-white/70 max-w-2xl">{desc}</p>}
          <p class="mt-3 text-white/60 text-sm">
            <time datetime={new Date(data.pubDate).toISOString()}>
              {new Intl.DateTimeFormat('en-ZA', { day:'2-digit', month:'short', year:'numeric' }).format(new Date(data.pubDate))}
            </time>
            {' · '}
            <span>{data.author || 'Digissential Team'}</span>
            {' · '}
            <span>{minutes} min read</span>
          </p>

          {Array.isArray(data.tags) && data.tags.length > 0 && (
            <p class="mt-3 flex flex-wrap gap-2">
              {data.tags.map((t: string) => {
                const slug = t.toLowerCase();
                return <a class="chip" href={`/blog/?tag=${encodeURIComponent(slug)}`}>{t}</a>;
              })}
            </p>
          )}
        </div>
      </header>

      <!-- Article body -->
      <div class="prose prose-invert max-w-none mt-8">
        <Content />
      </div>

      <hr class="my-10 border-white/10" />

      <nav class="flex flex-wrap gap-3 justify-between items-center">
        <div>
          {prev && <a class="btn btn-outline" href={`/blog/${prev.slug}/`} rel="prev">&larr; {prev.title}</a>}
        </div>
        <a class="link-fancy" href="/blog/">Back to all posts</a>
        <div>
          {next && <a class="btn btn-outline" href={`/blog/${next.slug}/`} rel="next">{next.title} &rarr;</a>}
        </div>
      </nav>

      <script type="application/ld+json">{JSON.stringify(articleLd)}</script>
    </article>
  </main>

  <style>
    .chip {
      @apply inline-flex items-center gap-1 rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs text-white/80 hover:text-white hover:border-white/20 transition;
      white-space: nowrap;
    }
  </style>
</Base>
