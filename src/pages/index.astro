---
import Base from '@layouts/Base.astro';
import Section from '@components/Section.astro';
import Button from '@components/Button.astro';
import Badge from '@components/Badge.astro';
import FeatureCard from '@components/FeatureCard.astro';
import Trust from '@components/Trust.astro';
import { getCollection } from 'astro:content';
import WebSiteLD from '@components/WebSiteLD.astro';
import ContactForm from '@components/ContactForm.astro';
import ContactInfoCard from '@components/ContactInfoCard.astro';
import BundlesGrid from "@components/BundlesGrid.astro";

// Bundles for home + JSON-LD
const allBundles = await getCollection('bundles', ({ data }) => !data.draft);
const topBundles = allBundles
  .sort((a,b) => (b.data.featured ? 1 : 0) - (a.data.featured ? 1 : 0) || a.slug.localeCompare(b.slug))
  .slice(0, 6);

const urlFor = (p: string) => Astro.site ? new URL(p, Astro.site).href : p;
---
<Base>
  <a id="top" class="sr-only">Top</a>

  <WebSiteLD />

  <section class="relative z-0 hero-bg pt-28 sm:pt-32 pb-14 bg-gradient-to-b from-digi-bg to-digi-ink/60">
    <div class="container-prose grid gap-10 md:grid-cols-2 items-center">
      <div class="relative">
        <img src="/assets/hero-tech.svg" alt="" aria-hidden="true" class="pointer-events-none absolute -right-10 -top-6 w-40 md:w-56 opacity-40" />
        <Badge label="Stellenbosch • Computer Repair & IT Support" size="lg" />
        <h1 class="mt-4 text-4xl sm:text-5xl font-extrabold leading-tight">
          Keeping your <span class="text-digi-primary">tech essentials</span> perfect.
        </h1>
        <p class="mt-4 text-white/80 max-w-xl">
          Fast, honest repairs and support: Windows installs, data recovery, malware removal, upgrades, and remote help. No tech jargon — just real solutions.
        </p>
        <div class="mt-8 flex flex-wrap gap-3">
          <Button href="/contact/" class="w-full sm:w-auto">Get a free quote</Button>
          <Button href="/bundles/" variant="ghost" class="w-full sm:w-auto">View bundles</Button>
          <Button href="tel:+27664256314" variant="secondary" class="w-full sm:w-auto">Call now</Button>
        </div>
        <p class="mt-4 text-xs text-white/60">Transparent rates • POPIA-aligned privacy • CPA-aligned warranty</p>
      </div>

      <div class="relative">
        <div class="card p-6">
          <h3 class="font-semibold">Quick Contact</h3>
          <ContactForm subject="Quote request" source="home-quote" />
        </div>
      </div>
    </div>
  </section>

  <Section id="services" eyebrow="Services" title="What we do" description="Core services that solve 90% of everyday computer problems.">
    <div class="grid gap-6 md:grid-cols-3">
      <FeatureCard title="Windows Reinstalls" body="Clean installs, drivers, updates, and basic configuration for a fresh start.">
        <svg slot="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 5h7v7H3zM14 5h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/></svg>
      </FeatureCard>

      <FeatureCard title="Malware Removal" body="Deep scans and safe removal with a basic hardening baseline afterward.">
        <svg slot="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M1 12h22M4.93 4.93l14.14 14.14M19.07 4.93L4.93 19.07"/></svg>
      </FeatureCard>

      <FeatureCard title="Backups & Recovery" body="Backups before repair; best-effort recovery for accidental loss.">
        <svg slot="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4v6h6M20 20v-6h-6M5 19a9 9 0 1 0 0-14"/></svg>
      </FeatureCard>
    </div>
  </Section>

  <!-- BUNDLES -->
  <Section
    id="bundles"
    eyebrow="Bundles"
    title="Popular, flat-rate bundles"
    description="Clear prices. Labour included. Parts (if needed) are quoted separately and approved before we proceed."
  >
    <BundlesGrid variant="home" limit={6} />

    <p class="mt-6 text-sm text-white/70">
      These packages combine our most requested fixes — Windows reinstalls, malware cleanups, SSD upgrades, Wi-Fi setup, and data rescue with secure wipes —
      so you know the cost up-front. <a href="/bundles/" class="text-digi-primary underline underline-offset-2">See full bundle details</a>.
    </p>

    <!-- JSON-LD: ItemList of the 6 bundles -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "ItemList",
      "name": "Popular service bundles",
      "itemListOrder": "https://schema.org/ItemListOrderAscending",
      "itemListElement": topBundles.map((b, i) => ({
        "@type": "ListItem",
        "position": i + 1,
        "url": urlFor(`/bundles/${b.slug}/`),
        "item": {
          "@type": "Product",
          "name": b.data.title,
          "description": b.data.summary,
          "url": urlFor(`/bundles/${b.slug}/`),
          "offers": {
            "@type": "Offer",
            "price": (b.data.price || "").replace(/[^\d.]/g, ""),
            "priceCurrency": "ZAR",
            "url": urlFor(`/bundles/${b.slug}/`)
          }
        }
      }))
    })}></script>
  </Section>


  <Trust />

  <Section
    id="contact"
    eyebrow="Contact"
    title="Get help today"
    description="Fast replies during business hours. Remote support available."
  >
    <div class="grid gap-6 md:grid-cols-2">
      <div class="card p-6">
        <h3 class="font-semibold">Request a Quote</h3>
        <ContactForm subject="Quote request" source="home-contact" />
      </div>

      <ContactInfoCard
        phone="+27664256314"
        phoneDisplay="066 425 6314"
        email="digissentialteam@gmail.com"
        address="Stellenbosch & surrounds"
        mapQuery="Digissential, Stellenbosch, South Africa"
      />
    </div>
  </Section>

  <script>
    const attachCounter = (sel) => {
      document.querySelectorAll(sel).forEach((ta) => {
        const out = document.querySelector(ta.getAttribute('data-count-target'));
        const update = () => { if (out) out.textContent = String(ta.value.length); };
        ta.addEventListener('input', update);
        update();
      });
    };
    attachCounter('textarea[data-count-target]');
  </script>
</Base>
